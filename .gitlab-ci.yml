stages:
  - test
  - deploy

#############################################################
# ðŸš€ Code check
#############################################################
code-quailty:
  image: python:3.7
  stage: test
  allow_failure: false
  before_script:
    - echo "*********Reformatting code***********"
    - pip install flake8
    - pip install bandit
  script:
    - bandit .
    - flake8 --select B,C,E,F,W,T4,B9 --ignore E501,W503,F401,F541 --max-line-length 79 --max-complexity 18

#############################################################
# ðŸš€ Deploy
#############################################################
deploy:
  stage: deploy
  script:
    - echo "My First CICD pipeline "
    - echo  "$NAME"
    - npm install
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set default.region $AWS_DEFAULT_REGION
    - aws cloudformation package --template-file $SAM_TEMPLATE --s3-bucket seu-bucket-s3 --output-template-file packaged.yaml
    - aws cloudformation deploy --template-file packaged.yaml --stack-name nome-da-sua-stack --capabilities CAPABILITY_IAM
    - aws lambda update-function-code --function-name $LAMBDA_FUNCTION_NAME --s3-bucket seu-bucket-s3 --s3-key serverless/nome-da-sua-stack/latest.zip
